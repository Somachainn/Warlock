<!DOCTYPE html>
<html lang="so">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laam Wallet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    /* ... CSS kii hore oo dhan halkan waa la sii hayaa ... */
  </style>
</head>
<body>
<div class="app">

  <h1>Laam Wallet</h1>

  <!-- AUTH (sida file-kii hore) -->
  <div id="authCard" class="card"> ... </div>

  <!-- LOGGED IN -->
  <div id="walletView" style="display:none">

    <!-- Portfolio -->
    <div class="card"> ... </div>

    <!-- Middle buttons -->
    <div class="card"> ... </div>

    <!-- My Assets -->
    <div class="card"> ... </div>

  </div>

  <!-- SEND MODAL -->
  <div id="sendModal" class="modal">
    <div class="modal-card">
      <button class="close-x" id="sendClose">&times;</button>
      <h3 class="modal-title">Send Asset</h3>
      <div class="row">
        <label>Asset</label>
        <select id="sendAsset"><option>XLM</option><option>Laam</option></select>
      </div>
      <div class="row">
        <label>Amount</label>
        <input id="sendAmt" type="number" step="0.0000001" placeholder="e.g. 10" />
      </div>
      <div class="row">
        <label>Destination (G…)</label>
        <input id="sendDst" type="text" placeholder="GXXXXXXXXXXXXXXXX" />
      </div>
      <!-- ✅ Memo input -->
      <div class="row" id="memoRow">
        <label>Memo (optional, only for XLM)</label>
        <input id="sendMemo" type="text" placeholder="Text / ID" />
      </div>
      <div class="row"><button id="sendNow">Send Now</button></div>
    </div>
  </div>

  <!-- RECEIVE MODAL -->
  <div id="recvModal" class="modal"> ... </div>

</div>

<script>
/* ==== CONFIG ==== */
const server = new StellarSdk.Server('https://horizon.stellar.org');
const ISSUER = 'GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64';
const LAAM  = new StellarSdk.Asset('Laam', ISSUER);
const XLM   = StellarSdk.Asset.native();

/* ==== STATE ==== */
let keypair=null, account=null;
let bestAsk=null;

/* ==== HELPERS ==== */
function fmt(n,d=2){return (Number(n)||0).toFixed(d)}

/* ==== PRICE UPDATE ==== */
function laamPriceFromOrderbook(){
  return bestAsk ? parseFloat(bestAsk.price) : 0;
}

/* ==== REALTIME ORDERBOOK ==== */
server.orderbook(LAAM, XLM).stream({
  onmessage: ob=>{
    bestAsk = ob.asks?.[0] || null;
    updatePrices();
  }
});

async function updatePrices(){
  const xlmRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=stellar&vs_currencies=usd');
  const j = await xlmRes.json();
  const xlmUsd = j?.stellar?.usd || 0;
  const laamInXLM = laamPriceFromOrderbook();
  const laamUsd = laamInXLM * xlmUsd;

  document.getElementById('laamPriceXLM').textContent = fmt(laamInXLM,7);
  document.getElementById('laamUsdPrice').textContent = fmt(laamUsd,4);
  document.getElementById('xlmUsdPrice').textContent = fmt(xlmUsd,4);
}

/* ==== SEND ==== */
document.getElementById('sendNow').addEventListener('click', async ()=>{
  const assetSel=document.getElementById('sendAsset').value;
  const amt=document.getElementById('sendAmt').value.trim();
  const dst=document.getElementById('sendDst').value.trim();
  const memoTxt=document.getElementById('sendMemo').value.trim();

  if(!keypair || !account){ alert('Unlock first'); return }
  if(!amt || !dst){ alert('Fill all fields'); return }

  try{
    let txb = new StellarSdk.TransactionBuilder(account,{
      fee:StellarSdk.BASE_FEE,
      networkPassphrase:StellarSdk.Networks.PUBLIC
    });

    const asset = assetSel==='XLM' ? XLM : LAAM;
    txb.addOperation(StellarSdk.Operation.payment({
      destination:dst,
      asset,
      amount:String(amt)
    }));

    // ✅ Memo only if XLM & user provided
    if(assetSel==='XLM' && memoTxt){
      txb.addMemo(StellarSdk.Memo.text(memoTxt));
    }

    const tx=txb.setTimeout(30).build();
    tx.sign(keypair);
    await server.submitTransaction(tx);
    alert('Payment sent!');
  }catch(e){
    alert('Send failed: '+(e?.response?.data?.extras?.result_codes?.operations||e.message));
  }
});
</script>
</body>
</html>
