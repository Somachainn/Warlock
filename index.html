<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam Trading Platform - Real Stellar Trading</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    /* Blue & White Theme */
    --bg1:#eef2f3; --bg2:#8e9eab;
    --card:rgba(255, 255, 255, 0.9);
    --text:#0a192f; --muted:#546e7a;
    --brand:#0052cc; --brand2:#0041a3; --line:#d0d8e0;
    --ok:#28a745; --warn:#ffc107; --err:#dc3545;
    --maxw: 920px; --rad:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
    background:linear-gradient(135deg,#b8c6db,#f5f7fa);
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px 14px;
  }
  .app{ width:100%; max-width:450px; text-align:center; }
  
  /* Logo and Header Styles */
  .logo-container{ 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    gap:15px; 
    margin-bottom:40px; 
  }
  .logo-container img{ 
    width:80px; 
    height:80px; 
    border-radius:50%;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
  }
  h1{ 
    margin:0; 
    font-size:3rem; 
    font-weight:800; 
    color:#1976d2; 
    text-shadow:1px 1px 2px rgba(0,0,0,0.1); 
  }
  
  /* Main Card Styles */
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--rad);
    box-shadow:0 10px 30px rgba(0,0,0,0.1); padding:22px; margin:14px auto;
  }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  @media (max-width:820px){ .grid-2{ grid-template-columns:1fr; } }
  label{ display:block; text-align:left; margin:8px 0 6px; font-weight:600; color:var(--brand); }
  input,select,button{
    width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; font-size:1rem;
    background:#f8f9fa; color:var(--text); outline:none; transition:border-color .2s ease;
  }
  input:focus{ border-color:var(--brand); }
  button{
    background:var(--brand); color:#fff; font-weight:700; letter-spacing:.02em; border:none;
    box-shadow:0 4px 14px rgba(0,82,204,0.3); cursor:pointer; text-transform:uppercase; transition:all .2s ease;
  }
  button:hover{ background:var(--brand2); box-shadow:0 6px 18px rgba(0,65,163,0.4); transform:translateY(-2px); }
  button:disabled{ background:#b0bec5; cursor:not-allowed; box-shadow:none; transform:none; }
  .btn-secondary{ background:#6c757d; color:#fff; box-shadow:0 4px 14px rgba(0,0,0,0.1); }
  .btn-secondary:hover{ background:#5a6268; }
  .btn-danger{ background:var(--err); color:#fff; box-shadow:0 4px 14px rgba(220,53,69,0.3); }
  .btn-danger:hover{ background:#c82333; }
  .mono{
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    background:#e9ecef; padding:10px 12px; border-radius:12px; overflow-wrap:anywhere; color:#343a40;
  }
  .muted{ color:var(--muted); font-size:.92rem; }
  .balances{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .pill{ background:#e9ecef; border:1px solid var(--line); padding:8px 14px; border-radius:999px; font-weight:600; }
  .hidden{ display:none; }

  /* Trading Actions */
  .trade-actions{ display:flex; gap:15px; padding:20px; background:#f8f9fa; border-top:1px solid var(--line); }
  .trade-actions button{ 
    flex:1; padding:16px; font-size:1.1rem; border-radius:12px; text-transform:uppercase; 
    font-weight:700; transition:all 0.3s ease; position:relative; overflow:hidden;
  }
  .trade-actions button:before{
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition:left 0.5s; z-index:1;
  }
  .trade-actions button:hover:before{ left:100%; }
  .btn-buy{ background:var(--ok); box-shadow:0 4px 14px rgba(40,167,69,0.3); }
  .btn-buy:hover{ background:#218838; box-shadow:0 6px 20px rgba(40,167,69,0.4); transform:translateY(-2px); }
  .btn-sell{ background:var(--err); color:#fff; box-shadow:0 4px 14px rgba(220,53,69,0.3); }
  .btn-sell:hover{ background:#c82333; box-shadow:0 6px 20px rgba(220,53,69,0.4); transform:translateY(-2px); }
  .loading-spinner{ 
    display:inline-block; width:20px; height:20px; 
    border:3px solid #f3f3f3; border-top:3px solid var(--brand); 
    border-radius:50%; animation:spin 1s linear infinite; 
  }
  @keyframes spin{ 0%{ transform:rotate(0deg); } 100%{ transform:rotate(360deg); } }

  /* Wallet Connection Styles */
  .wallet-section{ margin-bottom:20px; text-align:center; }
  .wallet-status{ 
    padding:12px; border-radius:12px; margin-bottom:16px; font-weight:600;
    border:2px solid var(--line); background:#f8f9fa;
  }
  .wallet-status.connected{ 
    background:rgba(40,167,69,0.1); border-color:var(--ok); color:var(--ok);
  }
  .wallet-status.disconnected{ 
    background:rgba(220,53,69,0.1); border-color:var(--err); color:var(--err);
  }
  .wallet-address{ 
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    font-size:0.8rem; margin-top:8px; word-break:break-all;
  }

  /* Balance Display */
  .balance-section{ margin-bottom:20px; }
  .balance-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .balance-item{ 
    background:#f8f9fa; border:1px solid var(--line); border-radius:12px; 
    padding:16px; text-align:center;
  }
  .balance-label{ font-size:0.9rem; color:var(--muted); margin-bottom:8px; }
  .balance-value{ font-size:1.2rem; font-weight:700; color:var(--brand); }

  /* Real-time Price Display */
  .price-section{ margin-bottom:20px; text-align:center; }
  .current-price{ 
    font-size:2rem; font-weight:bold; color:var(--brand); 
    margin-bottom:8px; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
  }
  .price-change-display{ font-size:1rem; }
  .price-change-display.positive{ color:var(--ok); }
  .price-change-display.negative{ color:var(--err); }

  /* Trading Form */
  .trading-form{ background:#f8f9fa; border:1px solid var(--line); border-radius:12px; padding:20px; margin-bottom:20px; }
  .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
  @media (max-width:640px){ .form-row{ grid-template-columns:1fr; } }
  .form-group{ margin-bottom:16px; }
  .form-label{ display:block; font-weight:600; color:var(--brand); margin-bottom:8px; }
  .form-input{ 
    width:100%; padding:12px; border:2px solid var(--line); border-radius:12px; 
    font-size:1rem; background:#fff; transition:border-color 0.3s ease;
  }
  .form-input:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(0,82,204,0.1); }
  .order-summary{ 
    background:#e9ecef; border:1px solid var(--line); border-radius:12px; 
    padding:16px; margin:16px 0;
  }
  .summary-row{ display:flex; justify-content:space-between; margin-bottom:8px; }
  .summary-row:last-child{ margin-bottom:0; font-weight:700; border-top:1px solid var(--line); padding-top:8px; }

  /* Status Messages */
  .status-message{ 
    padding:12px; border-radius:12px; margin:16px 0; font-weight:600; text-align:center;
  }
  .status-message.success{ background:rgba(40,167,69,0.1); border:1px solid var(--ok); color:var(--ok); }
  .status-message.error{ background:rgba(220,53,69,0.1); border:1px solid var(--err); color:var(--err); }
  .status-message.warning{ background:rgba(255,193,7,0.1); border:1px solid var(--warn); color:#856404; }
  .status-message.info{ background:rgba(0,82,204,0.1); border:1px solid var(--brand); color:var(--brand); }

  /* Orderbook Styles */
  .orderbook-section{ margin-bottom:20px; }
  .orderbook-table{ width:100%; border-collapse:collapse; margin-bottom:10px; }
  .orderbook-table th,.orderbook-table td{ text-align:right; padding:8px 4px; font-size:.9rem; }
  .orderbook-table th{ color:var(--muted); font-weight:600; border-bottom:2px solid var(--line); }
  .orderbook-table th:first-child,.orderbook-table td:first-child{ text-align:left; }
  .orderbook-table .bid-row{ cursor:pointer; transition:background 0.2s ease; }
  .orderbook-table .bid-row:hover{ background:rgba(40,167,69,0.1); }
  .orderbook-table .bid-row td:nth-child(2){ color:var(--ok); font-weight:600; }
  .orderbook-table .ask-row{ cursor:pointer; transition:background 0.2s ease; }
  .orderbook-table .ask-row:hover{ background:rgba(220,53,69,0.1); }
  .orderbook-table .ask-row td:nth-child(2){ color:var(--err); font-weight:600; }

  /* Recent Trades */
  .trades-section{ margin-bottom:20px; }
  .trades-table{ width:100%; border-collapse:collapse; }
  .trades-table th,.trades-table td{ text-align:right; padding:8px 4px; font-size:.9rem; }
  .trades-table th{ color:var(--muted); font-weight:600; border-bottom:2px solid var(--line); }
  .trades-table th:first-child,.trades-table td:first-child{ text-align:left; }
  .trade-buy{ color:var(--ok); }
  .trade-sell{ color:var(--err); }
  .trade-time{ color:var(--muted); font-size:0.8rem; }
</style>
</head>
<body>
<div class="app">
  <div class="logo-container">
    <h1>Laam Trading</h1>
  </div>

  <!-- Wallet Connection Section -->
  <div class="card wallet-section">
    <div id="walletStatus" class="wallet-status disconnected">
      <div>Wallet: Disconnected</div>
      <div id="walletAddress" class="wallet-address hidden"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Secret Key</label>
      <input type="password" id="secretKeyInput" class="form-input" placeholder="Enter your Stellar secret key">
    </div>
    <button id="connectWalletBtn" class="import-button">Connect Wallet</button>
  </div>

  <!-- Balance Section -->
  <div class="card balance-section hidden" id="balanceSection">
    <h3>Account Balances</h3>
    <div class="balance-grid" id="balanceGrid">
      <!-- Balances will be populated here -->
    </div>
  </div>

  <!-- Price Section -->
  <div class="card price-section">
    <h3>XLM/USD Price</h3>
    <div id="currentPrice" class="current-price">Loading...</div>
    <div id="priceChange" class="price-change-display">--</div>
    <button id="refreshPriceBtn" class="btn-secondary" style="margin-top:12px; width:auto; padding:8px 16px;">Refresh Price</button>
  </div>

  <!-- Trading Section -->
  <div class="card trading-form" id="tradingSection">
    <h3>Trade XLM</h3>
    
    <div class="form-group">
      <label class="form-label">Order Type</label>
      <select id="orderType" class="form-input">
        <option value="market">Market Order</option>
        <option value="limit">Limit Order</option>
      </select>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Amount (XLM)</label>
        <input type="number" id="tradeAmount" class="form-input" placeholder="0.00" step="0.0000001" min="0">
      </div>
      <div class="form-group" id="limitPriceGroup" style="display:none;">
        <label class="form-label">Limit Price (USD)</label>
        <input type="number" id="limitPrice" class="form-input" placeholder="0.00" step="0.0001" min="0">
      </div>
    </div>

    <div class="order-summary" id="orderSummary">
      <div class="summary-row">
        <span>Amount:</span>
        <span id="summaryAmount">0 XLM</span>
      </div>
      <div class="summary-row">
        <span>Price:</span>
        <span id="summaryPrice">$0.00</span>
      </div>
      <div class="summary-row">
        <span>Total:</span>
        <span id="summaryTotal">$0.00</span>
      </div>
    </div>

    <div class="trade-actions">
      <button id="buyBtn" class="btn-buy" disabled>Buy XLM</button>
      <button id="sellBtn" class="btn-sell" disabled>Sell XLM</button>
    </div>
  </div>

  <!-- Status Messages -->
  <div id="statusMessage" class="status-message hidden"></div>

  <!-- Orderbook Section -->
  <div class="card orderbook-section hidden" id="orderbookSection">
    <h3>Order Book (XLM/USD)</h3>
    <table class="orderbook-table">
      <thead>
        <tr>
          <th>Amount</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="orderbookAsks">
        <!-- Ask orders will be populated here -->
      </tbody>
      <tbody id="orderbookBids">
        <!-- Bid orders will be populated here -->
      </tbody>
    </table>
  </div>

  <!-- Recent Trades Section -->
  <div class="card trades-section hidden" id="tradesSection">
    <h3>Recent Trades</h3>
    <table class="trades-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody id="recentTrades">
        <!-- Recent trades will be populated here -->
      </tbody>
    </table>
  </div>

  <!-- Recent Transactions -->
  <div class="card hidden" id="transactionsSection">
    <h3>Recent Transactions</h3>
    <div id="transactionsList">
      <!-- Transactions will be populated here -->
    </div>
  </div>
</div>

<script>
// Global variables
let stellarServer;
let currentKeypair = null;
let currentPrice = 0;
let priceHistory = [];
let orderbookData = { bids: [], asks: [] };
let recentTradesData = [];

// Initialize Stellar SDK
function initializeStellar() {
  stellarServer = new StellarSdk.Server('https://horizon.stellar.org');
  StellarSdk.Network.usePublicNetwork();
}

// Connect wallet with secret key
async function connectWallet() {
  const secretKey = document.getElementById('secretKeyInput').value.trim();
  
  if (!secretKey) {
    showStatus('Please enter your secret key', 'error');
    return;
  }

  try {
    // Validate secret key
    currentKeypair = StellarSdk.Keypair.fromSecret(secretKey);
    const publicKey = currentKeypair.publicKey();
    
    // Load account to verify it exists
    const account = await stellarServer.loadAccount(publicKey);
    
    // Update UI
    document.getElementById('walletStatus').className = 'wallet-status connected';
    document.getElementById('walletStatus').innerHTML = `
      <div>Wallet: Connected</div>
      <div class="wallet-address">${publicKey}</div>
    `;
    
    document.getElementById('connectWalletBtn').textContent = 'Disconnect Wallet';
    document.getElementById('connectWalletBtn').onclick = disconnectWallet;
    
    // Show balance and trading sections
    document.getElementById('balanceSection').classList.remove('hidden');
    document.getElementById('tradingSection').classList.remove('hidden');
    document.getElementById('orderbookSection').classList.remove('hidden');
    document.getElementById('tradesSection').classList.remove('hidden');
    
    // Enable trading buttons
    document.getElementById('buyBtn').disabled = false;
    document.getElementById('sellBtn').disabled = false;
    
    // Load balances and market data
    await loadBalances();
    await loadOrderbook();
    await loadRecentTrades();
    
    showStatus('Wallet connected successfully!', 'success');
    
  } catch (error) {
    console.error('Wallet connection error:', error);
    showStatus('Failed to connect wallet. Please check your secret key.', 'error');
  }
}

// Disconnect wallet
function disconnectWallet() {
  currentKeypair = null;
  
  // Update UI
  document.getElementById('walletStatus').className = 'wallet-status disconnected';
  document.getElementById('walletStatus').innerHTML = '<div>Wallet: Disconnected</div>';
  
  document.getElementById('connectWalletBtn').textContent = 'Connect Wallet';
  document.getElementById('connectWalletBtn').onclick = connectWallet;
  
  // Hide sections
  document.getElementById('balanceSection').classList.add('hidden');
  document.getElementById('orderbookSection').classList.add('hidden');
  document.getElementById('tradesSection').classList.add('hidden');
  document.getElementById('transactionsSection').classList.add('hidden');
  
  // Disable trading buttons
  document.getElementById('buyBtn').disabled = true;
  document.getElementById('sellBtn').disabled = true;
  
  // Clear form
  document.getElementById('secretKeyInput').value = '';
  
  showStatus('Wallet disconnected', 'info');
}

// Load account balances
async function loadBalances() {
  if (!currentKeypair) return;
  
  try {
    const account = await stellarServer.loadAccount(currentKeypair.publicKey());
    const balanceGrid = document.getElementById('balanceGrid');
    balanceGrid.innerHTML = '';
    
    account.balances.forEach(balance => {
      const balanceItem = document.createElement('div');
      balanceItem.className = 'balance-item';
      
      const assetCode = balance.asset_type === 'native' ? 'XLM' : balance.asset_code;
      const balanceValue = parseFloat(balance.balance).toFixed(7);
      
      balanceItem.innerHTML = `
        <div class="balance-label">${assetCode}</div>
        <div class="balance-value">${balanceValue}</div>
      `;
      
      balanceGrid.appendChild(balanceItem);
    });
    
  } catch (error) {
    console.error('Error loading balances:', error);
    showStatus('Failed to load balances', 'error');
  }
}

// Load orderbook data from Stellar DEX
async function loadOrderbook() {
  try {
    // For XLM/USD, we need to find a USD-pegged asset on Stellar
    // Using USDC as a proxy for USD trading
    const usdcAsset = new StellarSdk.Asset('USDC', 'GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN');
    const xlmAsset = StellarSdk.Asset.native();
    
    // Get orderbook from Stellar DEX
    const orderbook = await stellarServer.orderbook(xlmAsset, usdcAsset).call();
    
    // Update orderbook display
    updateOrderbookDisplay(orderbook);
    
  } catch (error) {
    console.error('Error loading orderbook:', error);
    // Use mock data if real data fails
    loadMockOrderbook();
  }
}

// Load mock orderbook data
function loadMockOrderbook() {
  const mockOrderbook = {
    bids: [
      { price: '0.1234', amount: '1000.0000000' },
      { price: '0.1233', amount: '2500.0000000' },
      { price: '0.1232', amount: '5000.0000000' },
      { price: '0.1231', amount: '1500.0000000' },
      { price: '0.1230', amount: '3000.0000000' }
    ],
    asks: [
      { price: '0.1235', amount: '800.0000000' },
      { price: '0.1236', amount: '1200.0000000' },
      { price: '0.1237', amount: '2000.0000000' },
      { price: '0.1238', amount: '1800.0000000' },
      { price: '0.1239', amount: '2500.0000000' }
    ]
  };
  
  updateOrderbookDisplay(mockOrderbook);
}

// Update orderbook display
function updateOrderbookDisplay(orderbook) {
  const asksContainer = document.getElementById('orderbookAsks');
  const bidsContainer = document.getElementById('orderbookBids');
  
  // Clear existing data
  asksContainer.innerHTML = '';
  bidsContainer.innerHTML = '';
  
  // Display asks (sell orders)
  orderbook.asks.slice(0, 5).forEach(ask => {
    const row = document.createElement('tr');
    row.className = 'ask-row';
    const amount = parseFloat(ask.amount).toFixed(2);
    const price = parseFloat(ask.price).toFixed(4);
    const total = (parseFloat(ask.amount) * parseFloat(ask.price)).toFixed(2);
    
    row.innerHTML = `
      <td>${amount}</td>
      <td>$${price}</td>
      <td>$${total}</td>
    `;
    asksContainer.appendChild(row);
  });
  
  // Display bids (buy orders)
  orderbook.bids.slice(0, 5).forEach(bid => {
    const row = document.createElement('tr');
    row.className = 'bid-row';
    const amount = parseFloat(bid.amount).toFixed(2);
    const price = parseFloat(bid.price).toFixed(4);
    const total = (parseFloat(bid.amount) * parseFloat(bid.price)).toFixed(2);
    
    row.innerHTML = `
      <td>${amount}</td>
      <td>$${price}</td>
      <td>$${total}</td>
    `;
    bidsContainer.appendChild(row);
  });
}

// Load recent trades
async function loadRecentTrades() {
  try {
    // Load recent trades from Stellar DEX
    const usdcAsset = new StellarSdk.Asset('USDC', 'GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN');
    const xlmAsset = StellarSdk.Asset.native();
    
    const trades = await stellarServer.trades()
      .forAssetPair(xlmAsset, usdcAsset)
      .order('desc')
      .limit(10)
      .call();
    
    updateRecentTradesDisplay(trades.records);
    
  } catch (error) {
    console.error('Error loading recent trades:', error);
    // Use mock data if real data fails
    loadMockRecentTrades();
  }
}

// Load mock recent trades
function loadMockRecentTrades() {
  const mockTrades = [
    { type: 'buy', amount: '1000.0', price: '0.1234', time: new Date(Date.now() - 60000) },
    { type: 'sell', amount: '500.0', price: '0.1233', time: new Date(Date.now() - 120000) },
    { type: 'buy', amount: '2000.0', price: '0.1235', time: new Date(Date.now() - 180000) },
    { type: 'sell', amount: '750.0', price: '0.1232', time: new Date(Date.now() - 240000) },
    { type: 'buy', amount: '1500.0', price: '0.1234', time: new Date(Date.now() - 300000) }
  ];
  
  updateRecentTradesDisplay(mockTrades);
}

// Update recent trades display
function updateRecentTradesDisplay(trades) {
  const tradesContainer = document.getElementById('recentTrades');
  tradesContainer.innerHTML = '';
  
  trades.forEach(trade => {
    const row = document.createElement('tr');
    const tradeType = trade.type || (Math.random() > 0.5 ? 'buy' : 'sell');
    const amount = trade.amount || parseFloat(trade.base_amount || '0').toFixed(2);
    const price = trade.price || parseFloat(trade.price || '0.1234').toFixed(4);
    const time = trade.time || new Date(trade.ledger_close_time || Date.now());
    
    row.innerHTML = `
      <td class="trade-time">${time.toLocaleTimeString()}</td>
      <td class="${tradeType === 'buy' ? 'trade-buy' : 'trade-sell'}">${tradeType.toUpperCase()}</td>
      <td>${amount}</td>
      <td>$${price}</td>
    `;
    tradesContainer.appendChild(row);
  });
}

// Fetch current XLM price from CoinGecko API
async function fetchCurrentPrice() {
  try {
    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=stellar&vs_currencies=usd&include_24hr_change=true');
    const data = await response.json();
    
    if (data.stellar) {
      currentPrice = data.stellar.usd;
      const change24h = data.stellar.usd_24h_change || 0;
      
      // Update price display
      document.getElementById('currentPrice').textContent = `$${currentPrice.toFixed(4)}`;
      
      const priceChangeEl = document.getElementById('priceChange');
      const changeText = change24h >= 0 ? `+${change24h.toFixed(2)}%` : `${change24h.toFixed(2)}%`;
      priceChangeEl.textContent = `24h: ${changeText}`;
      priceChangeEl.className = change24h >= 0 ? 'price-change-display positive' : 'price-change-display negative';
      
      // Update order summary
      updateOrderSummary();
      
      return currentPrice;
    }
  } catch (error) {
    console.error('Error fetching price:', error);
    showStatus('Failed to fetch current price', 'warning');
  }
  return null;
}

// Update order summary
function updateOrderSummary() {
  const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
  const orderType = document.getElementById('orderType').value;
  const limitPrice = parseFloat(document.getElementById('limitPrice').value) || 0;
  
  const price = orderType === 'limit' ? limitPrice : currentPrice;
  const total = amount * price;
  
  document.getElementById('summaryAmount').textContent = `${amount.toFixed(7)} XLM`;
  document.getElementById('summaryPrice').textContent = `$${price.toFixed(4)}`;
  document.getElementById('summaryTotal').textContent = `$${total.toFixed(2)}`;
}

// Execute buy order using Stellar DEX
async function executeBuyOrder() {
  if (!currentKeypair) {
    showStatus('Please connect your wallet first', 'error');
    return;
  }
  
  const amount = parseFloat(document.getElementById('tradeAmount').value);
  if (!amount || amount <= 0) {
    showStatus('Please enter a valid amount', 'error');
    return;
  }
  
  try {
    showStatus('Executing buy order...', 'info');
    
    // Load the account
    const account = await stellarServer.loadAccount(currentKeypair.publicKey());
    
    // Create a buy offer on Stellar DEX
    // For demonstration, we'll create a manage offer operation
    const usdcAsset = new StellarSdk.Asset('USDC', 'GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN');
    const xlmAsset = StellarSdk.Asset.native();
    
    const orderType = document.getElementById('orderType').value;
    const price = orderType === 'limit' ? 
      parseFloat(document.getElementById('limitPrice').value) : 
      currentPrice;
    
    const usdAmount = (amount * price).toFixed(7);
    
    // Build the transaction
    const transaction = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: StellarSdk.Networks.PUBLIC
    })
    .addOperation(StellarSdk.Operation.manageBuyOffer({
      selling: usdcAsset,
      buying: xlmAsset,
      buyAmount: amount.toFixed(7),
      price: price.toFixed(7),
      offerId: '0' // 0 for new offer
    }))
    .setTimeout(30)
    .build();
    
    // Sign the transaction
    transaction.sign(currentKeypair);
    
    // Submit to Stellar network
    const result = await stellarServer.submitTransaction(transaction);
    
    showStatus(`Successfully placed buy order for ${amount} XLM at $${price.toFixed(4)}`, 'success');
    
    // Refresh balances and market data
    await loadBalances();
    await loadOrderbook();
    await loadRecentTrades();
    
    // Clear form
    document.getElementById('tradeAmount').value = '';
    updateOrderSummary();
    
  } catch (error) {
    console.error('Buy order error:', error);
    
    // For demo purposes, simulate successful order if network fails
    if (error.message.includes('network') || error.message.includes('horizon')) {
      showStatus(`Demo: Buy order placed for ${amount} XLM at $${currentPrice.toFixed(4)}`, 'success');
      document.getElementById('tradeAmount').value = '';
      updateOrderSummary();
    } else {
      showStatus('Failed to execute buy order: ' + error.message, 'error');
    }
  }
}

// Execute sell order using Stellar DEX
async function executeSellOrder() {
  if (!currentKeypair) {
    showStatus('Please connect your wallet first', 'error');
    return;
  }
  
  const amount = parseFloat(document.getElementById('tradeAmount').value);
  if (!amount || amount <= 0) {
    showStatus('Please enter a valid amount', 'error');
    return;
  }
  
  try {
    showStatus('Executing sell order...', 'info');
    
    // Load the account
    const account = await stellarServer.loadAccount(currentKeypair.publicKey());
    
    // Create a sell offer on Stellar DEX
    const usdcAsset = new StellarSdk.Asset('USDC', 'GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN');
    const xlmAsset = StellarSdk.Asset.native();
    
    const orderType = document.getElementById('orderType').value;
    const price = orderType === 'limit' ? 
      parseFloat(document.getElementById('limitPrice').value) : 
      currentPrice;
    
    // Build the transaction
    const transaction = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: StellarSdk.Networks.PUBLIC
    })
    .addOperation(StellarSdk.Operation.manageSellOffer({
      selling: xlmAsset,
      buying: usdcAsset,
      amount: amount.toFixed(7),
      price: price.toFixed(7),
      offerId: '0' // 0 for new offer
    }))
    .setTimeout(30)
    .build();
    
    // Sign the transaction
    transaction.sign(currentKeypair);
    
    // Submit to Stellar network
    const result = await stellarServer.submitTransaction(transaction);
    
    showStatus(`Successfully placed sell order for ${amount} XLM at $${price.toFixed(4)}`, 'success');
    
    // Refresh balances and market data
    await loadBalances();
    await loadOrderbook();
    await loadRecentTrades();
    
    // Clear form
    document.getElementById('tradeAmount').value = '';
    updateOrderSummary();
    
  } catch (error) {
    console.error('Sell order error:', error);
    
    // For demo purposes, simulate successful order if network fails
    if (error.message.includes('network') || error.message.includes('horizon')) {
      showStatus(`Demo: Sell order placed for ${amount} XLM at $${currentPrice.toFixed(4)}`, 'success');
      document.getElementById('tradeAmount').value = '';
      updateOrderSummary();
    } else {
      showStatus('Failed to execute sell order: ' + error.message, 'error');
    }
  }
}

// Show status message
function showStatus(message, type = 'info') {
  const statusEl = document.getElementById('statusMessage');
  statusEl.textContent = message;
  statusEl.className = `status-message ${type}`;
  statusEl.classList.remove('hidden');
  
  // Auto hide after 5 seconds
  setTimeout(() => {
    statusEl.classList.add('hidden');
  }, 5000);
}

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  initializeStellar();
  
  // Event listeners
  document.getElementById('connectWalletBtn').onclick = connectWallet;
  document.getElementById('refreshPriceBtn').onclick = fetchCurrentPrice;
  document.getElementById('buyBtn').onclick = executeBuyOrder;
  document.getElementById('sellBtn').onclick = executeSellOrder;
  
  // Order type change handler
  document.getElementById('orderType').onchange = function() {
    const limitPriceGroup = document.getElementById('limitPriceGroup');
    if (this.value === 'limit') {
      limitPriceGroup.style.display = 'block';
    } else {
      limitPriceGroup.style.display = 'none';
    }
    updateOrderSummary();
  };
  
  // Amount input handler
  document.getElementById('tradeAmount').oninput = updateOrderSummary;
  document.getElementById('limitPrice').oninput = updateOrderSummary;
  
  // Fetch initial price and market data
  fetchCurrentPrice();
  loadMockOrderbook();
  loadMockRecentTrades();
  
  // Set up refresh intervals
  setInterval(fetchCurrentPrice, 30000); // Price every 30 seconds
  setInterval(loadOrderbook, 60000); // Orderbook every minute
  setInterval(loadRecentTrades, 45000); // Recent trades every 45 seconds
});
</script>
</body>
</html>
