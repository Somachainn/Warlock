<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam wallet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  :root{
    /* Blue & White Theme */
    --bg1:#eef2f3; --bg2:#8e9eab;
    --card:rgba(255, 255, 255, 0.9);
    --text:#0a192f; --muted:#546e7a;
    --brand:#0052cc; --brand2:#0041a3; --line:#d0d8e0;
    --ok:#28a745; --warn:#ffc107; --err:#dc3545;
    --maxw: 920px; --rad:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:24px 14px;
  }
  .app{ width:100%; max-width:var(--maxw); text-align:center; }
  .logo-container{ display:flex; align-items:center; justify-content:center; gap:15px; margin-bottom:18px; }
  .logo-container img{ width:50px; height:50px; }
  h1{ margin:0; font-size:2.2rem; font-weight:800; color:var(--brand); text-shadow:1px 1px 2px rgba(0,0,0,0.1); }
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--rad);
    box-shadow:0 10px 30px rgba(0,0,0,0.1); padding:22px; margin:14px auto;
  }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  @media (max-width:820px){ .grid-2{ grid-template-columns:1fr; } }
  label{ display:block; text-align:left; margin:8px 0 6px; font-weight:600; color:var(--brand); }
  input,select,button{
    width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; font-size:1rem;
    background:#f8f9fa; color:var(--text); outline:none; transition:border-color .2s ease;
  }
  input:focus{ border-color:var(--brand); }
  button{
    background:var(--brand); color:#fff; font-weight:700; letter-spacing:.02em; border:none;
    box-shadow:0 4px 14px rgba(0,82,204,0.3); cursor:pointer; text-transform:uppercase; transition:all .2s ease;
  }
  button:hover{ background:var(--brand2); box-shadow:0 6px 18px rgba(0,65,163,0.4); transform:translateY(-2px); }
  button:disabled{ background:#b0bec5; cursor:not-allowed; box-shadow:none; transform:none; }
  .btn-secondary{ background:#6c757d; color:#fff; box-shadow:0 4px 14px rgba(0,0,0,0.1); }
  .btn-secondary:hover{ background:#5a6268; }
  .btn-danger{ background:var(--err); color:#fff; box-shadow:0 4px 14px rgba(220,53,69,0.3); }
  .btn-danger:hover{ background:#c82333; }
  .mono{
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    background:#e9ecef; padding:10px 12px; border-radius:12px; overflow-wrap:anywhere; color:#343a40;
  }
  .muted{ color:var(--muted); font-size:.92rem; }
  .balances{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .pill{ background:#e9ecef; border:1px solid var(--line); padding:8px 14px; border-radius:999px; font-weight:600; }
  .hidden{ display:none; }
  .send-wrap{ display:none; margin-top:16px; text-align:left; border-top:1px solid var(--line); padding-top:16px; }
  .send-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media (max-width:640px){ .send-row{ grid-template-columns:1fr; } }

  /* Trade UI */
  .trade-card{ padding:0; overflow:hidden; }
  .trade-header{ display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--line); }
  .trade-header h3{ margin:0; font-size:1.2rem; }
  .trade-header .icon{ font-size:1.5rem; cursor:pointer; }
  .trade-asset-selector{ display:flex; align-items:center; justify-content:space-between; padding:16px 20px; background:#f8f9fa; }
  .asset-box{ display:flex; align-items:center; gap:8px; }
  .asset-box img{ width:24px; height:24px; }
  .asset-box .asset-name{ font-weight:600; }
  .asset-box .asset-issuer{ font-size:.8rem; color:var(--muted); }
  .swap-icon{ font-size:1.5rem; background:#fff; border-radius:50%; padding:5px; border:1px solid var(--line); cursor:pointer; }
  .trade-tabs{ display:flex; border-bottom:1px solid var(--line); }
  .trade-tabs .tab{ flex:1; padding:12px; text-align:center; cursor:pointer; font-weight:600; color:var(--muted); border-bottom:3px solid transparent; }
  .trade-tabs .tab.active{ color:var(--brand); border-bottom-color:var(--brand); }
  .orderbook-content{ padding:10px 20px 20px; }
  .orderbook-table{ width:100%; border-collapse:collapse; }
  .orderbook-table th,.orderbook-table td{ text-align:right; padding:8px 4px; font-size:.9rem; }
  .orderbook-table th{ color:var(--muted); font-weight:normal; }
  .orderbook-table th:first-child,.orderbook-table td:first-child{ text-align:left; }
  .orderbook-table .bid-row td:nth-child(2){ color:var(--ok); }
  .orderbook-table .ask-row td:nth-child(2){ color:var(--err); }
  .spread{ padding:12px 0; text-align:center; font-weight:bold; border-top:1px solid var(--line); border-bottom:1px solid var(--line); margin:8px 0; }
  .trade-actions{ display:flex; gap:15px; padding:20px; background:#f8f9fa; border-top:1px solid var(--line); }
  .trade-actions button{ flex:1; padding:14px; font-size:1.1rem; border-radius:12px; text-transform:uppercase; }
  .btn-buy{ background:var(--ok); box-shadow:0 4px 14px rgba(40,167,69,0.3); }
  .btn-buy:hover{ background:#218838; }
  .btn-sell{ background:#e0e0e0; color:var(--text); box-shadow:0 4px 14px rgba(0,0,0,0.1); }
  .btn-sell:hover{ background:#d5d5d5; }

  /* Modal */
  .trade-modal{ display:none; position:fixed; inset:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
  .trade-modal.show{ display:flex; }
  .modal-content{ background:var(--card); border:1px solid var(--line); border-radius:var(--rad); box-shadow:0 10px 30px rgba(0,0,0,0.1); padding:20px; max-width:420px; width:90%; max-height:90vh; overflow-y:auto; }
  .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .modal-title{ font-size:1.5rem; font-weight:700; color:var(--brand); margin:0; }
  .modal-close{ background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--muted); padding:0; width:auto; height:auto; box-shadow:none; text-transform:none; }
  .modal-close:hover{ color:var(--text); transform:none; box-shadow:none; }
  .panel{ background:#f8f9fa; border:1px solid var(--line); border-radius:12px; padding:20px; margin:0; }
  .titleRow{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .title{ font-size:1.2rem; font-weight:700; color:var(--brand); }
  .avail{ font-size:.9rem; color:var(--muted); }
  .field{ margin-bottom:16px; }
  .inputWrap{ position:relative; display:flex; align-items:center; }
  .inputWrap input{ padding-right:60px; margin:0; }
  .unit{ position:absolute; right:12px; color:var(--muted); font-weight:600; pointer-events:none; }
  .hint{ font-size:.8rem; color:var(--muted); margin-top:4px; text-align:left; }
  .rowBtns{ display:flex; gap:8px; margin-top:8px; }
  .rowBtns button{ flex:1; padding:8px 12px; font-size:.9rem; background:#e9ecef; color:var(--text); border:1px solid var(--line); text-transform:none; font-weight:600; }
  .rowBtns button:hover{ background:var(--brand); color:#fff; transform:none; }
  .totalBox{ margin-bottom:20px; }
  .totalBox input{ background:#e9ecef; color:var(--muted); }
  .cta{ padding:16px; font-size:1.1rem; font-weight:700; text-transform:uppercase; margin:0; }
  .cta.buy{ background:var(--ok); box-shadow:0 4px 14px rgba(40,167,69,0.3); }
  .cta.buy:hover{ background:#218838; }
  .cta.sell{ background:#e0e0e0; color:var(--text); box-shadow:0 4px 14px rgba(0,0,0,0.1); }
  .cta.sell:hover{ background:#d5d5d5; }
</style>
</head>
<body>
  <div class="app">
    <div class="logo-container">
      <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam Logo">
      <h1>Laam wallet</h1>
    </div>

    <!-- AUTH -->
    <div id="authSection">
      <div class="card">
        <div id="unlockView" class="hidden">
          <h3 style="margin:0 0 10px 0; color:var(--brand)">Unlock Wallet</h3>
          <label for="walletPassword">Password</label>
          <input id="walletPassword" type="password" placeholder="Enter your password" />
          <button id="unlockBtn" style="margin-top:10px;">Unlock</button>
          <p class="muted" style="margin-top:10px;"><a href="#" id="resetWalletLink">Reset and Import New Key</a></p>
        </div>

        <div id="initialView">
          <div class="grid-2">
            <div id="createWalletSection">
              <h3 style="margin:0 0 10px 0; color:var(--brand)">New User?</h3>
              <button id="showCreateWalletBtn">Create New Wallet</button>
              <div id="createWalletForm" class="hidden" style="margin-top:10px;">
                <button id="generateAccountBtn">Generate New Stellar Account</button>
                <label style="margin-top:10px;">New Secret Key</label>
                <div id="newSecret" class="mono">-</div>
                <label style="margin-top:10px;">New Public Key</label>
                <div id="newPublic" class="mono">-</div>
                <div class="muted" style="margin-top:6px;">
                  * Save your secret key securely!<br/>Copy your public key and deposit at least 2 XLM to activate.
                </div>
              </div>
            </div>
            <div>
              <h3 style="margin:0 0 10px 0; color:var(--brand)">Have a Wallet?</h3>
              <label>Enter Your Secret Key</label>
              <input id="secretKeyInput" type="password" placeholder="Starts with S..."/>
              <label style="margin-top:10px;">Create a Password to Save</label>
              <input id="savePasswordInput" type="password" placeholder="Min. 8 characters"/>
              <button id="importAndSaveBtn" style="margin-top:10px;">Import and Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOGGED IN -->
    <div id="loggedInView" class="hidden">
      <div class="card">
        <div class="balances">
          <div class="pill">
            <div>XLM: <span id="xlmBal">0.00</span></div>
            <div class="muted" style="font-size:0.8rem;">$<span id="xlmUsd">0.00</span> ($<span id="xlmPrice">0.00</span>/XLM)</div>
          </div>
          <div class="pill">
            <div>Laam: <span id="laamBal">0.00</span></div>
            <div class="muted" style="font-size:0.8rem;">$<span id="laamUsd">0.00</span> ($<span id="laamPrice">0.06</span>/Laam)</div>
          </div>
        </div>
        <label style="margin-top:10px;">Your Public Key</label>
        <div id="pubKey" class="mono">-</div>
        <div style="display:flex; gap:10px; margin-top:16px; justify-content:center;">
          <button id="btnSendToggle">Send</button>
          <button id="addTrustlineBtn">Add Laam Trustline</button>
          <button id="logoutBtn" class="btn-danger">Lock Wallet</button>
        </div>

        <div id="sendForm" class="send-wrap">
          <h4 style="margin:0 0 10px 0; color:var(--brand)">Send Assets</h4>
          <div class="send-row">
            <div><label for="sendAsset">Asset</label><select id="sendAsset"><option value="XLM">XLM</option><option value="LAAM">Laam</option></select></div>
            <div><label for="sendAmount">Amount</label><input id="sendAmount" type="number" step="0.0000001" placeholder="e.g. 10" /></div>
          </div>
          <label for="sendDest" style="margin-top:8px;">Destination Public Key</label>
          <input id="sendDest" type="text" placeholder="G... destination" />
          <button id="btnSend" style="margin-top:10px;">Send Now</button>
        </div>
      </div>

      <!-- Trade -->
      <div class="card trade-card">
        <div class="trade-header">
          <span class="icon">←</span>
          <h3>Trade</h3>
          <span class="icon" id="refreshOB">↻</span>
        </div>
        <div class="trade-asset-selector">
          <div class="asset-box">
            <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam">
            <div>
              <div class="asset-name">Laam</div>
              <div class="asset-issuer">laam.online</div>
            </div>
          </div>
          <span class="swap-icon" id="swapAssets">⇄</span>
          <div class="asset-box">
            <img src="https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png" alt="XLM">
            <div>
              <div class="asset-name">XLM</div>
              <div class="asset-issuer">stellar.org</div>
            </div>
          </div>
        </div>
        <div class="trade-tabs">
          <div class="tab" id="overviewTab">Overview</div>
          <div class="tab active" id="orderbookTab">Orderbook</div>
          <div class="tab" id="lastTradesTab">Last Trades</div>
        </div>
        <div class="orderbook-content" id="orderbookContent">
          <table class="orderbook-table">
            <thead><tr><th>Amount (Laam)</th><th>Price (XLM)</th><th>Total (XLM)</th></tr></thead>
            <tbody id="asksBody"></tbody>
          </table>
          <div class="spread" id="spreadValue">-</div>
          <table class="orderbook-table">
            <tbody id="bidsBody"></tbody>
          </table>
        </div>
        <div id="overviewContent" style="display:none; padding:10px 20px 20px;">
          <div style="font-size:2.5rem; font-weight:bold; text-align:center; margin-bottom:10px;"><span id="overviewLaamPriceXLM">0.00000</span> XLM</div>
          <div class="muted" style="text-align:center; font-size:.9rem; margin-bottom:20px;">Laam price (sample)</div>
          <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
            <button class="btn-secondary" style="flex:0 1 auto; padding:8px 15px; border-radius:8px;">1D</button>
            <button class="btn-secondary" style="flex:0 1 auto; padding:8px 15px; border-radius:8px;">1W</button>
            <button class="btn-secondary" style="flex:0 1 auto; padding:8px 15px; border-radius:8px;">1M</button>
            <button class="btn-secondary" style="flex:0 1 auto; padding:8px 15px; border-radius:8px;">1Y</button>
          </div>
          <div style="width:100%; height:200px; background:#f0f0f0; border-radius:12px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:var(--muted);">[Graph Placeholder]</div>
        </div>
        <div id="lastTradesContent" style="display:none; padding:10px 20px 20px;">
          <p class="muted">Recent trades will appear here.</p>
        </div>
        <div class="trade-actions">
          <button class="btn-buy" id="btnBuy">Buy</button>
          <button class="btn-sell" id="btnSell">Sell</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Trade Modal -->
  <div id="tradeModal" class="trade-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Buy Laam</h3>
        <button class="modal-close" onclick="closeTradeModal()">&times;</button>
      </div>
      <div class="panel">
        <div class="titleRow">
          <div class="title" id="panelTitle">Buy Laam</div>
          <div class="avail">Available: <span id="availBalance">0 XLM</span></div>
        </div>

        <div class="field">
          <div class="inputWrap">
            <input id="modalPrice" type="number" step="0.0000001" placeholder="0.135" />
            <div class="unit">XLM</div>
          </div>
          <div class="hint">Price (XLM per Laam)</div>
        </div>

        <div class="field">
          <div class="inputWrap">
            <input id="modalAmount" type="number" step="0.0000001" placeholder="Amount" />
            <div class="unit">Laam</div>
          </div>
          <div class="rowBtns">
            <button data-fill="25">25%</button>
            <button data-fill="50">50%</button>
            <button data-fill="75">75%</button>
            <button data-fill="100">100%</button>
          </div>
        </div>

        <div class="totalBox">
          <div class="inputWrap">
            <input id="modalTotal" type="number" step="0.0000001" placeholder="0.0000000" disabled />
            <div class="unit">XLM</div>
          </div>
          <div class="hint" id="totalHint">Total XLM you'll pay</div>
        </div>

        <button class="cta buy" id="modalConfirmBtn">Buy Laam</button>
      </div>
    </div>
  </div>

<script>
/* ====== SETUP ====== */
const server = new StellarSdk.Server('https://horizon.stellar.org');
const ISSUER = 'GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64';
const LAAM  = new StellarSdk.Asset('Laam', ISSUER);
const XLM   = StellarSdk.Asset.native();
const ENCRYPTED_KEY_NAME = 'laam_dex_wallet_v4';

/* ====== STATE ====== */
let keypair = null, account = null, balTimer = null;
let asks = [], bids = [];
let currentTradeType = 'buy';

/* ====== HELPERS ====== */
function encryptKey(secretKey, password){ return CryptoJS.AES.encrypt(secretKey, password).toString(); }
function decryptKey(encryptedKey, password){ const bytes = CryptoJS.AES.decrypt(encryptedKey, password); return bytes.toString(CryptoJS.enc.Utf8); }
function walletExists(){ return !!localStorage.getItem(ENCRYPTED_KEY_NAME); }
function showView(view){
  document.getElementById('authSection').style.display = (view==='loggedIn')?'none':'block';
  document.getElementById('loggedInView').style.display = (view==='loggedIn')?'block':'none';
  document.getElementById('unlockView').classList.toggle('hidden', view!=='unlock');
  document.getElementById('initialView').classList.toggle('hidden', view!=='initial');
}
function alertTxError(err){
  const rc = err?.response?.data?.extras?.result_codes;
  if(rc){
    alert('Failed: ' + JSON.stringify(rc));
  }else{
    alert('Failed: ' + (err.message || err));
  }
}

/* ====== AUTH ====== */
async function login(secret){
  try{
    keypair = StellarSdk.Keypair.fromSecret(secret);
    account = await server.loadAccount(keypair.publicKey());
    document.getElementById('pubKey').textContent = keypair.publicKey();
    showView('loggedIn');
    await loadOrderbook();
    await refreshBalances();
    if(balTimer) clearInterval(balTimer);
    balTimer = setInterval(refreshBalances, 15000);
  }catch(e){
    keypair=null; account=null;
    const msg = (e.message||'').includes('404') ? 'Account not found. Fund with ≥2 XLM to activate.' : 'Could not load account. Check your key.';
    alert(msg);
    showView(walletExists() ? 'unlock' : 'initial');
  }
}
function logout(){
  keypair=null; account=null;
  if(balTimer) clearInterval(balTimer);
  document.getElementById('walletPassword').value='';
  showView(walletExists() ? 'unlock' : 'initial');
}

/* ====== BALANCES ====== */
async function refreshBalances(){
  if(!keypair) return;
  try{
    account = await server.loadAccount(keypair.publicKey());
    let xlm=0, laam=0;
    for(const b of account.balances){
      if(b.asset_type==='native') xlm=parseFloat(b.balance);
      if(b.asset_code==='Laam' && b.asset_issuer===ISSUER) laam=parseFloat(b.balance);
    }
    document.getElementById('xlmBal').textContent = xlm.toFixed(2);
    document.getElementById('laamBal').textContent = laam.toFixed(2);

    const rate = await fetchXlmToUsdRate();
    if(rate){
      document.getElementById('xlmPrice').textContent = rate.toFixed(4);
      document.getElementById('xlmUsd').textContent = (xlm*rate).toFixed(2);
      const laamPriceXLM = asks.length? parseFloat(asks[0].price) : 0;
      const laamPriceUSD = laamPriceXLM * rate;
      document.getElementById('laamPrice').textContent = laamPriceUSD.toFixed(4);
      document.getElementById('laamUsd').textContent = (laam*laamPriceUSD).toFixed(2);
    }
  }catch(e){ console.error('Balance refresh failed:', e); }
}
async function fetchXlmToUsdRate(){
  try{
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=stellar&vs_currencies=usd');
    const j = await r.json();
    return j?.stellar?.usd || null;
  }catch{ return null; }
}

/* ====== ORDERBOOK ====== */
async function loadOrderbook(){
  try{
    const ob = await server.orderbook(LAAM, XLM).call();
    asks = ob.asks || []; bids = ob.bids || [];
    const asksBody = document.getElementById('asksBody');
    const bidsBody = document.getElementById('bidsBody');

    asksBody.innerHTML = (asks.slice(0,8)).map(a=>{
      const amount=parseFloat(a.amount), price=parseFloat(a.price), total=amount*price;
      return `<tr class="ask-row"><td>${amount.toFixed(2)}</td><td>${price.toFixed(7)}</td><td>${total.toFixed(4)}</td></tr>`;
    }).join('') || `<tr><td colspan="3" class="muted">No asks</td></tr>`;

    bidsBody.innerHTML = (bids.slice(0,8)).map(b=>{
      const amount=parseFloat(b.amount), price=parseFloat(b.price), total=amount*price;
      return `<tr class="bid-row"><td>${amount.toFixed(2)}</td><td>${price.toFixed(7)}</td><td>${total.toFixed(4)}</td></tr>`;
    }).join('') || `<tr><td colspan="3" class="muted">No bids</td></tr>`;

    const spreadEl = document.getElementById('spreadValue');
    if(asks.length && bids.length){
      spreadEl.textContent = (parseFloat(asks[0].price)-parseFloat(bids[0].price)).toFixed(7);
    }else{
      spreadEl.textContent = '-';
    }
    const overviewPriceEl = document.getElementById('overviewLaamPriceXLM');
    if(overviewPriceEl && asks.length){ overviewPriceEl.textContent = parseFloat(asks[0].price).toFixed(5); }
  }catch(e){
    console.error('Orderbook error:', e);
    document.getElementById('asksBody').innerHTML = `<tr><td colspan="3" class="muted">Error loading offers</td></tr>`;
    document.getElementById('bidsBody').innerHTML = `<tr><td colspan="3" class="muted">Error loading offers</td></tr>`;
  }
}

/* ====== TRADE MODAL ====== */
function openTradeModal(type){
  currentTradeType = type;
  const modal = document.getElementById('tradeModal');
  document.getElementById('modalTitle').textContent = (type==='buy')?'Buy Laam':'Sell Laam';
  document.getElementById('panelTitle').textContent = (type==='buy')?'Buy Laam':'Sell Laam';
  document.getElementById('totalHint').textContent = (type==='buy')?"Total XLM you'll pay":"Total XLM you'll receive";
  const confirmBtn = document.getElementById('modalConfirmBtn');
  confirmBtn.textContent = (type==='buy')?'Buy Laam':'Sell Laam';
  confirmBtn.className = 'cta ' + (type==='buy'?'buy':'sell');

  // Set available balance line
  let availTxt = '0 XLM';
  if(account){
    for(const b of account.balances){
      if(type==='buy' && b.asset_type==='native'){ availTxt = `${parseFloat(b.balance).toFixed(2)} XLM`; break; }
      if(type==='sell' && b.asset_code==='Laam' && b.asset_issuer===ISSUER){ availTxt = `${parseFloat(b.balance).toFixed(2)} Laam`; break; }
    }
  }
  document.getElementById('availBalance').textContent = availTxt;

  // Default price helper from top of book
  if(asks.length && type==='buy'){
    document.getElementById('modalPrice').value = parseFloat(asks[0].price).toFixed(7);
  }else if(bids.length && type==='sell'){
    document.getElementById('modalPrice').value = parseFloat(bids[0].price).toFixed(7);
  }else{
    document.getElementById('modalPrice').value = '';
  }
  document.getElementById('modalAmount').value = '';
  document.getElementById('modalTotal').value = '';
  modal.classList.add('show');
}
function closeTradeModal(){ document.getElementById('tradeModal').classList.remove('show'); }
function calculateModalTotal(){
  const p = parseFloat(document.getElementById('modalPrice').value)||0;
  const a = parseFloat(document.getElementById('modalAmount').value)||0;
  document.getElementById('modalTotal').value = (p*a).toFixed(7);
}
function fillModalPercentage(percentage){
  if(!account) return;
  let available=0;
  if(currentTradeType==='buy'){
    for(const b of account.balances){ if(b.asset_type==='native'){ available=parseFloat(b.balance); break; } }
    const price=parseFloat(document.getElementById('modalPrice').value)||0;
    if(price>0){
      const maxAmt = (available*percentage/100)/price;
      document.getElementById('modalAmount').value = maxAmt.toFixed(7);
    }
  }else{
    for(const b of account.balances){ if(b.asset_code==='Laam' && b.asset_issuer===ISSUER){ available=parseFloat(b.balance); break; } }
    document.getElementById('modalAmount').value = (available*percentage/100).toFixed(7);
  }
  calculateModalTotal();
}
async function ensureTrustline(){
  // Returns true if Laam trustline exists, false otherwise
  if(!account) return false;
  return account.balances.some(b=> b.asset_code==='Laam' && b.asset_issuer===ISSUER);
}
async function executeModalTrade(){
  if(!keypair){ alert('Please login first'); return; }
  const price = parseFloat(document.getElementById('modalPrice').value);
  const amount = parseFloat(document.getElementById('modalAmount').value);
  if(!isFinite(price) || price<=0 || !isFinite(amount) || amount<=0){
    alert('Enter valid price and amount'); return;
  }
  try{
    // Always reload fresh account for sequence
    account = await server.loadAccount(keypair.publicKey());

    if(currentTradeType==='buy'){
      // Need trustline to receive Laam
      const hasTL = await ensureTrustline();
      if(!hasTL){ alert('Add Laam trustline first (click "Add Laam Trustline").'); return; }

      const fee = await server.fetchBaseFee();
      const tx = new StellarSdk.TransactionBuilder(account, {
        fee, networkPassphrase: StellarSdk.Networks.PUBLIC
      })
      .addOperation(StellarSdk.Operation.manageBuyOffer({
        selling: XLM,
        buying: LAAM,
        buyAmount: amount.toFixed(7),
        price: price.toString()
      }))
      .setTimeout(30)
      .build();
      tx.sign(keypair);
      await server.submitTransaction(tx);
      alert('Buy order submitted!');
    }else{
      const fee = await server.fetchBaseFee();
      const tx = new StellarSdk.TransactionBuilder(account, {
        fee, networkPassphrase: StellarSdk.Networks.PUBLIC
      })
      .addOperation(StellarSdk.Operation.manageSellOffer({
        selling: LAAM,
        buying: XLM,
        amount: amount.toFixed(7),
        price: price.toString(),
        offerId: '0'
      }))
      .setTimeout(30)
      .build();
      tx.sign(keypair);
      await server.submitTransaction(tx);
      alert('Sell order submitted!');
    }
    closeTradeModal();
    await refreshBalances();
    await loadOrderbook();
  }catch(e){
    console.error('Trade failed:', e);
    alertTxError(e);
  }
}

/* ====== TABS ====== */
function switchTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(name+'Tab').classList.add('active');
  document.getElementById('orderbookContent').style.display='none';
  document.getElementById('overviewContent').style.display='none';
  document.getElementById('lastTradesContent').style.display='none';
  document.getElementById(name+'Content').style.display='block';
}

/* ====== EVENTS ====== */
// Auth UI
document.getElementById('showCreateWalletBtn').addEventListener('click', (e)=>{ document.getElementById('createWalletForm').classList.remove('hidden'); e.target.classList.add('hidden'); });
document.getElementById('generateAccountBtn').addEventListener('click', ()=>{
  const kp = StellarSdk.Keypair.random();
  document.getElementById('newSecret').textContent = kp.secret();
  document.getElementById('newPublic').textContent = kp.publicKey();
});
document.getElementById('importAndSaveBtn').addEventListener('click', async ()=>{
  const secret = document.getElementById('secretKeyInput').value.trim();
  const password = document.getElementById('savePasswordInput').value;
  if(!secret || !password) return alert('Please enter both secret key and password');
  if(password.length<8) return alert('Password must be at least 8 characters');
  try{
    StellarSdk.Keypair.fromSecret(secret);
    const enc = encryptKey(secret,password);
    localStorage.setItem(ENCRYPTED_KEY_NAME, enc);
    await login(secret);
  }catch{ alert('Invalid secret key'); }
});
document.getElementById('unlockBtn').addEventListener('click', async ()=>{
  const pw = document.getElementById('walletPassword').value;
  const enc = localStorage.getItem(ENCRYPTED_KEY_NAME);
  if(!pw || !enc) return alert('Enter password');
  try{
    const secret = decryptKey(enc, pw);
    if(!secret) throw new Error('bad');
    await login(secret);
  }catch{ alert('Invalid password'); }
});
document.getElementById('resetWalletLink').addEventListener('click', (e)=>{
  e.preventDefault();
  if(confirm('Delete saved wallet?')){ localStorage.removeItem(ENCRYPTED_KEY_NAME); showView('initial'); }
});

// Wallet actions
document.getElementById('logoutBtn').addEventListener('click', logout);
document.getElementById('btnSendToggle').addEventListener('click', ()=>{
  const el = document.getElementById('sendForm');
  el.style.display = (el.style.display==='none' || !el.style.display)? 'block':'none';
});
document.getElementById('addTrustlineBtn').addEventListener('click', async ()=>{
  if(!keypair){ return alert('Login first'); }
  try{
    account = await server.loadAccount(keypair.publicKey());
    const fee = await server.fetchBaseFee();
    const tx = new StellarSdk.TransactionBuilder(account,{
      fee, networkPassphrase: StellarSdk.Networks.PUBLIC
    })
    .addOperation(StellarSdk.Operation.changeTrust({ asset: LAAM }))
    .setTimeout(30)
    .build();
    tx.sign(keypair);
    await server.submitTransaction(tx);
    alert('Laam trustline added!');
    await refreshBalances();
  }catch(e){ console.error(e); alertTxError(e); }
});
document.getElementById('btnSend').addEventListener('click', async ()=>{
  if(!keypair) return alert('Login first');
  const asset = document.getElementById('sendAsset').value;
  const amount = document.getElementById('sendAmount').value;
  const destination = document.getElementById('sendDest').value.trim();
  if(!amount || !destination) return alert('Fill all fields');
  try{
    account = await server.loadAccount(keypair.publicKey());
    const fee = await server.fetchBaseFee();
    const tb = new StellarSdk.TransactionBuilder(account,{ fee, networkPassphrase: StellarSdk.Networks.PUBLIC });
    tb.addOperation(StellarSdk.Operation.payment({
      destination,
      asset: asset==='XLM'? XLM : LAAM,
      amount: parseFloat(amount).toFixed(7)
    }));
    const tx = tb.setTimeout(30).build(); tx.sign(keypair);
    await server.submitTransaction(tx);
    alert('Payment sent!');
    document.getElementById('sendAmount').value=''; document.getElementById('sendDest').value='';
    document.getElementById('sendForm').style.display='none';
    await refreshBalances();
  }catch(e){ console.error(e); alertTxError(e); }
});

// Trading buttons & modal
document.getElementById('btnBuy').addEventListener('click', ()=>openTradeModal('buy'));
document.getElementById('btnSell').addEventListener('click', ()=>openTradeModal('sell'));
document.getElementById('modalPrice').addEventListener('input', calculateModalTotal);
document.getElementById('modalAmount').addEventListener('input', calculateModalTotal);
document.getElementById('modalConfirmBtn').addEventListener('click', executeModalTrade);
document.querySelectorAll('.rowBtns button').forEach(btn=>{
  btn.addEventListener('click', ()=> fillModalPercentage(parseInt(btn.dataset.fill)));
});
document.getElementById('tradeModal').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeTradeModal(); });

// Tabs & refresh
document.getElementById('overviewTab').addEventListener('click', ()=>switchTab('overview'));
document.getElementById('orderbookTab').addEventListener('click', ()=>switchTab('orderbook'));
document.getElementById('lastTradesTab').addEventListener('click', ()=>switchTab('lastTrades'));
document.getElementById('refreshOB').addEventListener('click', loadOrderbook);
document.getElementById('swapAssets').addEventListener('click', ()=> alert('Swap UI placeholder'));

/* ====== INIT ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  showView(walletExists()? 'unlock':'initial');
  if(!walletExists()){ loadOrderbook(); }
});
</script>
</body>
</html>
